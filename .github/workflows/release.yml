name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.7.2'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build
        run: |
          qmake ElegantWeather.pro CONFIG+=release
          nmake

      - name: Deploy
        run: |
          mkdir deploy
          copy release\ElegantWeather.exe deploy\
          cd deploy
          windeployqt.exe ElegantWeather.exe --qmldir ..\ --release
          cd ..
          xcopy /E /I weather-ai-agent deploy\weather-ai-agent

      - name: Package
        run: |
          Compress-Archive -Path deploy\* -DestinationPath ElegantWeather-Windows-${{ github.ref_name }}.zip

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          files: ElegantWeather-Windows-${{ github.ref_name }}.zip

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.7.2'
          host: 'mac'
          target: 'desktop'

      - name: Build
        run: |
          qmake ElegantWeather.pro CONFIG+=release
          make

      - name: Deploy
        run: |
          macdeployqt ElegantWeather.app -qmldir=. -dmg
          cp -r weather-ai-agent ElegantWeather.app/Contents/MacOS/
          hdiutil create -srcfolder ElegantWeather.app -volname "ElegantWeather" -format UDZO ElegantWeather-macOS-${{ github.ref_name }}.dmg

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          files: ElegantWeather-macOS-${{ github.ref_name }}.dmg

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-render-util0 libxcb-xinerama0 libxcb-cursor0 libfuse2

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.7.2'
          host: 'linux'
          target: 'desktop'

      - name: Build
        run: |
          qmake ElegantWeather.pro CONFIG+=release
          make

      - name: Download linuxdeploy
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage

      - name: Create desktop file
        run: |
          cat > ElegantWeather.desktop << EOF
          [Desktop Entry]
          Type=Application
          Name=ElegantWeather
          Comment=Modern weather application with AI insights
          Exec=ElegantWeather
          Icon=elegantweather
          Categories=Utility;
          Terminal=false
          EOF

      - name: Create icon
        run: |
          # Create a simple PNG icon (1x1 pixel placeholder)
          echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==" | base64 -d > elegantweather.png

      - name: Prepare AppDir
        run: |
          mkdir -p AppDir/usr/bin
          chmod +x ElegantWeather
          cp ElegantWeather AppDir/usr/bin/
          cp -r weather-ai-agent AppDir/usr/bin/

      - name: Create AppImage
        run: |
          export QMAKE=$Qt6_DIR/bin/qmake
          export VERSION=${{ github.ref_name }}
          ./linuxdeploy-x86_64.AppImage --appdir=AppDir \
            --plugin qt \
            --desktop-file=ElegantWeather.desktop \
            --icon-file=elegantweather.png \
            --output appimage || (echo "linuxdeploy failed, trying without Qt plugin..." && \
            ./linuxdeploy-x86_64.AppImage --appdir=AppDir \
            --desktop-file=ElegantWeather.desktop \
            --icon-file=elegantweather.png \
            --output appimage)
          ls -la *.AppImage
          mv ElegantWeather*.AppImage ElegantWeather-Linux-${{ github.ref_name }}.AppImage || echo "No AppImage found, listing directory:" && ls -la

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          files: ElegantWeather-Linux-${{ github.ref_name }}.AppImage
